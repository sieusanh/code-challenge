<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard System Architecture Diagrams</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.0/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            margin-bottom: 20px;
            padding: 10px;
            background: linear-gradient(90deg, #f0f0ff 0%, transparent 100%);
            border-left: 4px solid #667eea;
        }
        .diagram-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow-x: auto;
        }
        .mermaid {
            text-align: center;
        }
        .description {
            margin: 20px 0;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        .note {
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Scoreboard System Architecture Diagrams</h1>
        
        <div class="description">
            <strong>System Overview:</strong> Event-driven architecture with CQRS pattern for optimal performance and scalability.
            The system separates read and write operations, uses caching extensively, and provides real-time updates through WebSockets.
        </div>

        <h2>1. High-Level System Architecture</h2>
        <div class="diagram-container">
            <div class="mermaid">
                graph TB
                    subgraph "Client Layer"
                        WEB[Web Application]
                        MOB[Mobile App]
                    end
                    
                    subgraph "API Layer"
                        GW[API Gateway<br/>Auth/Rate Limiting]
                        RT[Real-time Service<br/>WebSocket/SSE]
                    end
                    
                    subgraph "Service Layer"
                        CMD[Command Service<br/>Write Operations]
                        QRY[Query Service<br/>Read Operations]
                        VAL[Validation Service<br/>Anti-cheat]
                    end
                    
                    subgraph "Message Layer"
                        EB[Event Bus<br/>Message Broker]
                        CACHE[Cache Layer<br/>Redis/Memcached]
                    end
                    
                    subgraph "Data Layer"
                        WDB[(Write DB<br/>PostgreSQL)]
                        RDB[(Read DB<br/>Optimized)]
                        AUDIT[(Audit DB)]
                    end
                    
                    WEB --> GW
                    MOB --> GW
                    WEB -.->|WebSocket| RT
                    MOB -.->|WebSocket| RT
                    
                    GW --> CMD
                    GW --> QRY
                    CMD --> VAL
                    
                    CMD --> WDB
                    CMD --> EB
                    QRY --> CACHE
                    CACHE --> RDB
                    
                    EB --> QRY
                    EB --> RT
                    EB --> AUDIT
                    
                    VAL --> WDB
                    
                    style GW fill:#ff9999
                    style EB fill:#99ccff
                    style CACHE fill:#ffcc99
                    style RT fill:#99ff99
            </div>
        </div>

        <h2>2. Score Update Flow (Sequence Diagram)</h2>
        <div class="diagram-container">
            <div class="mermaid">
                sequenceDiagram
                    participant U as User
                    participant FE as Frontend
                    participant GW as API Gateway
                    participant CS as Command Service
                    participant VAL as Validation Service
                    participant DB as Write DB
                    participant EB as Event Bus
                    participant QS as Query Service
                    participant CACHE as Cache
                    participant RT as Real-time Service
                    participant OC as Other Clients
                    
                    U->>FE: Perform Action
                    FE->>GW: POST /api/actions
                    GW->>GW: Validate JWT Token
                    GW->>GW: Check Rate Limit
                    GW->>CS: Forward Request
                    CS->>VAL: Validate Action
                    VAL->>VAL: Check Anti-cheat Rules
                    VAL-->>CS: Validation Result
                    
                    alt Valid Action
                        CS->>DB: Store Action
                        CS->>DB: Update Score
                        CS->>EB: Publish ScoreUpdated Event
                        CS-->>GW: 202 Accepted
                        GW-->>FE: Action Accepted
                        
                        EB->>QS: ScoreUpdated Event
                        QS->>DB: Update Read Model
                        QS->>CACHE: Invalidate Cache
                        CACHE->>CACHE: Refresh Top 10
                        
                        EB->>RT: ScoreUpdated Event
                        RT->>FE: Push Update (WebSocket)
                        RT->>OC: Broadcast Update
                    else Invalid Action
                        VAL-->>CS: Rejection Reason
                        CS-->>GW: 400 Bad Request
                        GW-->>FE: Error Response
                    end
            </div>
        </div>

        <h2>3. Data Flow Diagram</h2>
        <div class="diagram-container">
            <div class="mermaid">
                graph LR
                    subgraph "Input"
                        UA[User Action]
                        API[API Request]
                    end
                    
                    subgraph "Processing"
                        AUTH[Authentication]
                        VALID[Validation]
                        CALC[Score Calculation]
                        TRANS[Transform]
                    end
                    
                    subgraph "Storage"
                        ACTIONS[(Actions DB)]
                        SCORES[(Scores DB)]
                        LEADER[(Leaderboard)]
                        AUDIT_LOG[(Audit Log)]
                    end
                    
                    subgraph "Output"
                        REST[REST Response]
                        WS[WebSocket Event]
                        CACHED[Cached Data]
                    end
                    
                    UA --> API
                    API --> AUTH
                    AUTH --> VALID
                    VALID --> CALC
                    CALC --> ACTIONS
                    CALC --> SCORES
                    
                    SCORES --> TRANS
                    TRANS --> LEADER
                    LEADER --> CACHED
                    
                    CACHED --> REST
                    LEADER --> WS
                    
                    VALID --> AUDIT_LOG
                    CALC --> AUDIT_LOG
                    
                    style AUTH fill:#ffcccc
                    style VALID fill:#ccffcc
                    style CALC fill:#ccccff
                    style CACHED fill:#ffffcc
            </div>
        </div>

        <h2>4. State Transition Diagram (User Score State)</h2>
        <div class="diagram-container">
            <div class="mermaid">
                stateDiagram-v2
                    [*] --> Idle: User Registered
                    
                    Idle --> ActionPending: Submit Action
                    ActionPending --> Validating: Process Action
                    
                    Validating --> ScoreUpdating: Valid Action
                    Validating --> Rejected: Invalid Action
                    
                    ScoreUpdating --> Broadcasting: Update Complete
                    Broadcasting --> CacheInvalidating: Notify Subscribers
                    CacheInvalidating --> Idle: Cache Refreshed
                    
                    Rejected --> Idle: Log Rejection
                    
                    state Validating {
                        [*] --> CheckAuth
                        CheckAuth --> CheckRate: Authenticated
                        CheckRate --> CheckRules: Within Limits
                        CheckRules --> CheckAnomaly: Rules Pass
                        CheckAnomaly --> [*]: No Anomaly
                    }
                    
                    state ScoreUpdating {
                        [*] --> CalculateScore
                        CalculateScore --> UpdateDB
                        UpdateDB --> UpdateRank
                        UpdateRank --> [*]
                    }
            </div>
        </div>

        <h2>5. Component Interaction Flowchart</h2>
        <div class="diagram-container">
            <div class="mermaid">
                flowchart TD
                    Start([User Action]) --> Auth{Authenticated?}
                    Auth -->|No| Reject1[Return 401]
                    Auth -->|Yes| RateLimit{Rate Limit OK?}
                    
                    RateLimit -->|No| Reject2[Return 429]
                    RateLimit -->|Yes| Validate{Valid Action?}
                    
                    Validate -->|No| Reject3[Return 400]
                    Validate -->|Yes| StoreAction[Store in DB]
                    
                    StoreAction --> CalcScore[Calculate New Score]
                    CalcScore --> CheckTop{In Top 10?}
                    
                    CheckTop -->|Yes| UpdateLeader[Update Leaderboard]
                    CheckTop -->|No| UpdateScore[Update Score Only]
                    
                    UpdateLeader --> InvalidCache[Invalidate Cache]
                    UpdateScore --> PublishEvent[Publish Event]
                    InvalidCache --> PublishEvent
                    
                    PublishEvent --> Broadcast[Broadcast to Clients]
                    Broadcast --> UpdateUI[Update UI Real-time]
                    
                    UpdateUI --> End([Complete])
                    
                    Reject1 --> End
                    Reject2 --> End
                    Reject3 --> End
                    
                    style Start fill:#90EE90
                    style End fill:#FFB6C1
                    style UpdateLeader fill:#FFD700
            </div>
        </div>

        <h2>6. Security Flow Diagram</h2>
        <div class="diagram-container">
            <div class="mermaid">
                graph TB
                    subgraph "Security Layers"
                        REQ[Incoming Request]
                        
                        L1[Layer 1: DDoS Protection]
                        L2[Layer 2: Rate Limiting]
                        L3[Layer 3: Authentication]
                        L4[Layer 4: Authorization]
                        L5[Layer 5: Input Validation]
                        L6[Layer 6: Business Rules]
                        L7[Layer 7: Anomaly Detection]
                        
                        PROC[Process Request]
                        AUDIT[Audit Log]
                    end
                    
                    REQ --> L1
                    L1 -->|Pass| L2
                    L2 -->|Pass| L3
                    L3 -->|Pass| L4
                    L4 -->|Pass| L5
                    L5 -->|Pass| L6
                    L6 -->|Pass| L7
                    L7 -->|Pass| PROC
                    
                    L1 -->|Fail| BLOCK1[Block IP]
                    L2 -->|Fail| THROTTLE[Throttle User]
                    L3 -->|Fail| UNAUTH[401 Unauthorized]
                    L4 -->|Fail| FORBID[403 Forbidden]
                    L5 -->|Fail| INVALID[400 Bad Request]
                    L6 -->|Fail| REJECT[Business Rule Violation]
                    L7 -->|Fail| SUSPECT[Flag Suspicious]
                    
                    PROC --> AUDIT
                    SUSPECT --> AUDIT
                    
                    style L1 fill:#ff9999
                    style L3 fill:#99ccff
                    style L7 fill:#ffcc99
                    style AUDIT fill:#ccffcc
            </div>
        </div>

        <h2>7. Cache Strategy Flow</h2>
        <div class="diagram-container">
            <div class="mermaid">
                flowchart LR
                    subgraph "Read Path"
                        R1[Read Request] --> C1{Cache Hit?}
                        C1 -->|Yes| R2[Return Cached]
                        C1 -->|No| R3[Query Database]
                        R3 --> R4[Update Cache]
                        R4 --> R5[Return Data]
                    end
                    
                    subgraph "Write Path"
                        W1[Score Update] --> W2[Update Database]
                        W2 --> W3[Invalidate Cache]
                        W3 --> W4[Publish Event]
                        W4 --> W5[Refresh Cache]
                    end
                    
                    subgraph "Cache Management"
                        CM1[TTL Expiry]
                        CM2[LRU Eviction]
                        CM3[Manual Invalidation]
                        CM4[Warm Cache on Startup]
                    end
                    
                    R2 -.->|Monitor| CM1
                    W5 -.->|Trigger| CM3
                    CM4 -.->|Initialize| C1
                    
                    style C1 fill:#ffffcc
                    style W3 fill:#ffcccc
                    style CM4 fill:#ccffcc
            </flowchart>
        </div>

        <div class="note">
            <strong>üìå Key Design Benefits:</strong>
            <ul>
                <li><strong>Scalability:</strong> Each component can scale independently</li>
                <li><strong>Performance:</strong> Caching and read-optimized database ensure fast queries</li>
                <li><strong>Real-time:</strong> WebSocket connections provide instant updates</li>
                <li><strong>Security:</strong> Multiple validation layers prevent cheating</li>
                <li><strong>Reliability:</strong> Event-driven architecture ensures eventual consistency</li>
                <li><strong>Maintainability:</strong> Clear separation of concerns and modular design</li>
            </ul>
        </div>

        <div class="description">
            <strong>Implementation Notes:</strong>
            <br><br>
            1. <strong>Database Choice:</strong> PostgreSQL for ACID compliance and JSONB support for flexible event storage
            <br>2. <strong>Caching Strategy:</strong> Redis with 5-minute TTL for leaderboard, instant invalidation on updates
            <br>3. <strong>Message Queue:</strong> RabbitMQ or Kafka for reliable event delivery
            <br>4. <strong>Real-time Protocol:</strong> WebSockets with SSE fallback for broader compatibility
            <br>5. <strong>Security:</strong> JWT with 15-minute expiry, refresh token rotation, and comprehensive audit logging
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#7C3AED',
                lineColor: '#5B21B6',
                secondaryColor: '#764ba2',
                tertiaryColor: '#f0f0ff'
            }
        });
    </script>
</body>
</html>